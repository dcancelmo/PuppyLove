<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Socket.IO Chat Example</title>
        <script src="http://127.0.0.1:3000/socket.io/socket.io.js"></script>
        <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
        <link rel = "stylesheet" type = "text/css" href = "style/styleDash.css" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font: 13px Helvetica, Arial;
            }
            form {
                background: #000;
                padding: 3px;
                position: fixed;
                bottom: 0;
                width: 100%;
            }
            form input {
                border: 0;
                padding: 10px;
                width: 90%;
                margin-right: .5%;
            }
            form button {
                width: 9%;
                background: rgb(130, 224, 255);
                border: none;
                padding: 10px;
            }
            #messages {
                list-style-type: none;
                margin: 0;
                padding: 0;
            }
            #messages li {
                padding: 5px 10px;
            }
            #messages li:nth-child(odd) {
                background: #eee;
            }
        </style>
    </head>
    <body>
    <div id = "navbar">
        <ul>
            <li><a href = "dashboard.html">Dashboard</a></li>
            <li><a href="view_profile.html">Profile</a></li>
            <li><a href = "matches.html">Matches</a></li>
            <li><a href = "messages.html">Messages</a></li>
            <li><a href = "user_profile.html">Settings</a></li>
            <li><a href = "cgi-bin/logout.py">Log out</a></li>
        </ul>
    </div>
   
    <div id = "messages" style = "margin-left:100px">
        <ul id="messages"></ul>
      
        <form action="">
            <input id="m" autocomplete="off"/><button>Send</button>
        </form>
    </div>
        <script>
            function readCookie(name) {
                var nameEQ = name + "=";
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }
            // web sockets do allow cross-domain connections.  It is generally up to the
            // server to determine whether or not a connection from an incoming client
            // should be accepted or not.
            // no URL is specified when this socket is opened because by default the
            // socket will try to connect back to the host from which this page was
            // served (which in this case is the desired behavior).
            var socket = io.connect('http://127.0.0.1:3000');
            // this function is called when the user presses ENTER or clicks the Submit
            // button in the form.
            $('form').submit(function() {
                // gets and logs the message that the user is about to send over the web
                // socket.
                var message = $('#m').val();
                console.log("should transmit message: " + message);
                // uses the socket.emit() function to send the message over the socket
                // as a 'chat message' event.  the server will inspect the event type
                // and call an appropriate event handler to handle it.
                socket.emit('chat message', $('#m').val());
                // blanks out the message field (so that the user can type a fresh
                // message)
                $('#m').val('');
                // returns false so that the page is not reloaded every time that the
                // form is submitted, which would cause the socket to disconnect and
                // reconnect, and blank out any messages in the window.
                return false;
            });
            // this event handler is called whenever the socket RECEIVES a 'chat message'
            // event from the server.  this will be called when the client's own messages
            // are sent back, but also if/when another client sends a message to the same
            // server using the 'chat message' event.
            socket.on('chat message', function(msg) {
                $.ajax({
                    url: 'cgi-bin/get_username.py',
                    type: 'GET',
                    dataType: 'text',
                    success: function(response){
                        var response = JSON.parse(response);
                        var username = response.username;
                        $('#messages').append($('<li>').text(username+": "+msg));
                    },
                    error: function(request, status, error){
                        console.log(error);
                    }
                });
                // add the contents of the message to the unordered list.
            });
         </script>
    </body>
</html>